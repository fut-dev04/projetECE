<!DOCTYPE html>
<html lang="fr" ng-app="demandeApp">
<head>
  <meta charset="UTF-8">
  <title>Gestion des Demandes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.3/angular.min.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="app.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body class="container py-4" ng-controller="DemandeController">

  <h1 class="text-center text-primary mb-4">📋 Gestion des demandes</h1>

  <!-- Connexion -->
  <div ng-if="!isLoggedIn" class="card p-4 shadow" style="max-width:400px;margin:auto;">
    <h3 class="text-center mb-3">Connexion</h3>
    <form ng-submit="login()">
      <div class="mb-3">
        <input type="text" ng-model="loginData.username" class="form-control" placeholder="Nom d'utilisateur" required>
      </div>
      <div class="mb-3">
        <input type="password" ng-model="loginData.password" class="form-control" placeholder="Mot de passe" required>
      </div>
      <button type="submit" class="btn btn-primary w-100">Se connecter</button>
    </form>
    <p class="text-center mt-3">Pas encore de compte ? <a href="/register">📝 S’inscrire</a></p>
  </div>

  <!-- Si connecté -->
  <div ng-if="isLoggedIn">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <p>
        Connecté en tant que <strong>{{currentUser.username}}</strong> ({{currentUser.role}})
      </p>
      <div>
        <button ng-click="logout()" class="btn btn-danger">Déconnexion</button>
        <a ng-if="currentUser.role === 'admin'" href="/admin" class="btn btn-warning ms-2">Espace Admin</a>
      </div>
    </div>

    <!-- Formulaire ajout / modification -->
    <div class="card p-3 shadow mb-4">
      <form ng-submit="ajouterDemande()">
        <div class="row g-2">
          <div class="col"><input type="text" ng-model="nouvelleDemande.prenom" class="form-control" placeholder="Prénom" required></div>
          <div class="col"><input type="text" ng-model="nouvelleDemande.nom" class="form-control" placeholder="Nom" required></div>
          <div class="col">
            <select ng-model="nouvelleDemande.sexe" class="form-select" required>
              <option value="">Sexe</option>
              <option value="M">Masculin</option>
              <option value="F">Féminin</option>
            </select>
          </div>
        </div>
        <div class="row g-2 mt-2">
          <div class="col"><input type="text" ng-model="nouvelleDemande.handicap" class="form-control" placeholder="Handicap" required></div>
          <div class="col"><input type="text" ng-model="nouvelleDemande.type" class="form-control" placeholder="Type" required></div>
        </div>
        <div class="mt-3 d-flex gap-2">
          <button type="submit" class="btn btn-success">{{ nouvelleDemande.id ? "Modifier" : "Ajouter" }}</button>
          <button type="button" ng-click="resetForm()" ng-if="nouvelleDemande.id" class="btn btn-secondary">Annuler</button>
        </div>
      </form>
    </div>

    <!-- Liste des demandes -->
    <div class="card p-3 shadow">
      <h4>📌 Mes demandes</h4>
      <ul class="list-group mt-3">
        <li ng-repeat="demande in demandes" class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <strong>#{{demande.id}}</strong> - {{demande.prenom}} {{demande.nom}}
            ({{demande.sexe}}, {{demande.handicap}}, {{demande.type}})
            <em>[{{demande.date}}] - Statut: {{demande.statut}}</em>
          </div>

          <div class="btn-group">
            <button class="btn btn-sm btn-outline-primary" ng-click="editerDemande(demande)" 
              ng-disabled="demande.statut !== 'en_attente' && currentUser.role !== 'admin'">✏ Modifier</button>
            <button class="btn btn-sm btn-outline-danger" ng-click="supprimerDemande(demande.id)" 
              ng-disabled="demande.statut !== 'en_attente' && currentUser.role !== 'admin'">🗑 Supprimer</button>
          </div>

          <!-- Boutons admin -->
          <div ng-if="currentUser.role === 'admin'" class="btn-group ms-2">
            <button class="btn btn-sm btn-secondary" ng-click="changerStatut(demande, 'en_attente')">🕓 Attente</button>
            <button class="btn btn-sm btn-warning" ng-click="changerStatut(demande, 'en_cours')">⚙ En cours</button>
            <button class="btn btn-sm btn-success" ng-click="changerStatut(demande, 'traitee')">✅ Traitée</button>
          </div>
        </li>
      </ul>
    </div>
  </div>

</body>
</html>